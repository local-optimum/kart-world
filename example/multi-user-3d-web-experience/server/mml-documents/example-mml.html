<!-- <m-group id="stairs" z="10" y="0.1"></m-group> -->

<!-- Race Track Environment -->
<m-model 
  id="racetrack" 
  src="https://mmlstorage.com/3a26161fadce611cc9f55ae5ff56edc7052ace05622e9468bef11a747851a5b4"
  x="-235.366" 
  y="18.59" 
  z="44.947"
  rx="0"
  ry="0" 
  rz="0"
  sx="0.1"
  sy="0.1"
  sz="0.1"
  collision-interval="100"
></m-model>

<!-- Collectible Cartoon Tree -->
<m-group id="tree-group" x="0" y="1.5" z="5">
  <!-- 3D Tree Model -->
  <m-model 
    id="cartoon-tree"
    src="https://mmlstorage.com/b58aebd0e8e13fee1d5e99012ee1ed53bbf2e40631a90a1353317b2be12c7d9a" 
    x="0" 
    y="-2"
    z="0" 
    sx="0.005" 
    sy="0.005" 
    sz="0.005"
  ></m-model>

  <!-- Warning Labels - Visible when tree is present (4 rotations for 360° visibility) -->
  <m-label
    id="tree-warning-label-0"
    content="DO NOT HIT THIS TREE"
    font-size="120"
    font-color="red"
    alignment="center"
    y="7"
    width="15"
    height="2"
    emissive="0"
    visible="true"
    collide="false"
    color="rgb(0,0,0)"
    ry="0"
  ></m-label>
  
  <m-label
    id="tree-warning-label-90"
    content="DO NOT HIT THIS TREE"
    font-size="120"
    font-color="red"
    alignment="center"
    y="7"
    width="15"
    height="2"
    emissive="0"
    visible="true"
    collide="false"
    color="rgb(0,0,0)"
    ry="90"
  ></m-label>
  
  <m-label
    id="tree-warning-label-180"
    content="DO NOT HIT THIS TREE"
    font-size="120"
    font-color="red"
    alignment="center"
    y="7"
    width="15"
    height="2"
    emissive="0"
    visible="true"
    collide="false"
    color="rgb(0,0,0)"
    ry="180"
  ></m-label>
  
  <m-label
    id="tree-warning-label-270"
    content="DO NOT HIT THIS TREE"
    font-size="120"
    font-color="red"
    alignment="center"
    y="7"
    width="15"
    height="2"
    emissive="0"
    visible="true"
    collide="false"
    color="rgb(0,0,0)"
    ry="270"
  ></m-label>

  <!-- Despawn Labels - Visible when tree is gone (4 rotations for 360° visibility) -->
  <m-label
    id="tree-despawn-label-0"
    content="NOOO YOU CLIMATE CHANGED!!"
    font-size="100"
    font-color="#FF6600"
    alignment="center"
    y="3"
    width="18"
    height="1.5"
    emissive="0.5"
    color="rgb(0,0,0)"
    visible="false"
    collide="false"
    ry="0"
  ></m-label>
  
  <m-label
    id="tree-despawn-label-90"
    content="NOOO YOU CLIMATE CHANGED!!"
    font-size="100"
    font-color="#FF6600"
    alignment="center"
    y="3"
    width="18"
    height="1.5"
    emissive="0.5"
    color="rgb(0,0,0)"
    visible="false"
    collide="false"
    ry="90"
  ></m-label>
  
  <m-label
    id="tree-despawn-label-180"
    content="NOOO YOU CLIMATE CHANGED!!"
    font-size="100"
    font-color="#FF6600"
    alignment="center"
    y="3"
    width="18"
    height="1.5"
    emissive="0.5"
    color="rgb(0,0,0)"
    visible="false"
    collide="false"
    ry="180"
  ></m-label>
  
  <m-label
    id="tree-despawn-label-270"
    content="NOOO YOU CLIMATE CHANGED!!"
    font-size="100"
    font-color="#FF6600"
    alignment="center"
    y="3"
    width="18"
    height="1.5"
    emissive="0.5"
    color="rgb(0,0,0)"
    visible="false"
    collide="false"
    ry="270"
  ></m-label>

  <!-- Position probe for detection -->
  <m-position-probe 
    id="tree-probe" 
    range="5" 
    interval="100"
    debug="false"
  ></m-position-probe>
</m-group>



<script>
  const treeGroup = document.getElementById("tree-group");
  const cartoonTree = document.getElementById("cartoon-tree");
  const treeProbe = document.getElementById("tree-probe");
  
  // Get all warning label variants (4 rotations)
  const warningLabels = [
    document.getElementById("tree-warning-label-0"),
    document.getElementById("tree-warning-label-90"),
    document.getElementById("tree-warning-label-180"),
    document.getElementById("tree-warning-label-270")
  ];
  
  // Get all despawn label variants (4 rotations)
  const despawnLabels = [
    document.getElementById("tree-despawn-label-0"),
    document.getElementById("tree-despawn-label-90"),
    document.getElementById("tree-despawn-label-180"),
    document.getElementById("tree-despawn-label-270")
  ];
  
  let treeCollected = false;

  function getHexForCurrentTime(lightness) {
    const hue = ((Date.now() % 2000)/2000) * 360;
    const saturation = 1.0;
    const alpha = saturation * Math.min(lightness, 1 - lightness);
    const getF = number => {
      const k = (number + hue / 30) % 12;
      return lightness - alpha * Math.max(-1, Math.min(k - 3, Math.min(9 - k, 1)))
    };
    const red = Math.round(255 * getF(0));
    const green = Math.round(255 * getF(8));
    const blue = Math.round(255 * getF(4));
    const hex = "#"+(red.toString(16).padStart(2, "0"))+(green.toString(16).padStart(2, "0"))+(blue.toString(16).padStart(2, "0"));
    return hex;
  }

  // Handle tree collection using position probe
  treeProbe.addEventListener("positionenter", (event) => {
    if (treeCollected) return; // Prevent multiple collections
    
    treeCollected = true;
    console.log("Tree collected! User:", event.detail.connectionId);
    
    // Get tree's current position dynamically
    const treePosition = {
      x: parseFloat(treeGroup.getAttribute("x") || "0"),
      y: parseFloat(treeGroup.getAttribute("y") || "0"),
      z: parseFloat(treeGroup.getAttribute("z") || "0")
    };
    
    // Remove the tree completely to prevent collision
    const treeModel = treeGroup.querySelector("m-model");
    const originalModelSrc = treeModel.getAttribute("src");
    const originalModelScale = {
      sx: treeModel.getAttribute("sx"),
      sy: treeModel.getAttribute("sy"),
      sz: treeModel.getAttribute("sz")
    };
    treeModel.removeAttribute("src"); // This removes the 3D model completely

    // Hide all warning labels and show all despawn labels
    warningLabels.forEach(label => label.setAttribute("visible", "false"));
    despawnLabels.forEach(label => label.setAttribute("visible", "true"));

    // Respawn tree after 3 seconds
    setTimeout(() => {
      console.log("Tree respawning...");
      treeCollected = false; // Reset collection state
      
      // Restore the tree model completely
      treeModel.setAttribute("src", originalModelSrc);
      treeModel.setAttribute("sx", originalModelScale.sx);
      treeModel.setAttribute("sy", originalModelScale.sy);
      treeModel.setAttribute("sz", originalModelScale.sz);

      // Show all warning labels and hide all despawn labels
      warningLabels.forEach(label => label.setAttribute("visible", "true"));
      despawnLabels.forEach(label => label.setAttribute("visible", "false"));
    }, 3000);
  });

  // Debug elements removed for clean racing environment
</script>
